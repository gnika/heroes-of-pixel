function Camera(e,a,t){this.x=0,this.y=0,this.width=a,this.height=t,this.maxX=e.cols*e.tsize-a,this.maxY=e.rows*e.tsize-t}function objet(e,a,t,i){this.name=e,this.life=t,this.attaque=i,this.image=Loader.getImage(a)}function animation(e,a,t,i){this.map=e,this.x=a,this.y=t,this.image=Loader.getImage(i)}DUREE_ANIMATION=50,builds=[],monsters=[],supply=[],clickCanvasX=0,clickCanvasY=0,xHeroClick=0,yHeroClick=0,menuclick=0,Camera.prototype.follow=function(e){this.following=e,e.screenX=0,e.screenY=0},Camera.prototype.update=function(){0!=this.following.life&&(this.following.screenX=this.width/2,this.following.screenY=this.height/2,this.x=this.following.x-this.width/2,this.y=this.following.y-this.height/2,this.x=Math.max(0,Math.min(this.x,this.maxX)),this.y=Math.max(0,Math.min(this.y,this.maxY)),(this.following.x<this.width/2||this.following.x>this.maxX+this.width/2)&&(this.following.screenX=this.following.x-this.x),(this.following.y<this.height/2||this.following.y>this.maxY+this.height/2)&&(this.following.screenY=this.following.y-this.y))},Game.load=function(){return[Loader.loadImage("tiles","assets/tiles_new.png"),Loader.loadImage("hero","assets/character.png"),Loader.loadImage("hero2","assets/character2.png"),Loader.loadImage("troll2","assets/troll2.png"),Loader.loadImage("troll3","assets/troll3.png"),Loader.loadImage("scorpion1","assets/scorpion1.png"),Loader.loadImage("scorpion2","assets/scorpion2.png"),Loader.loadImage("coin","assets/coin.png"),Loader.loadImage("cloud","assets/cloud.png"),Loader.loadImage("xp","assets/xp.png"),Loader.loadImage("ball","assets/ball.png"),Loader.loadImage("pain","assets/bread.png")]},Game.init=function(){var e=new Time;e.startTime(1e3),Keyboard.listenForEvents([Keyboard.LEFT,Keyboard.RIGHT,Keyboard.UP,Keyboard.DOWN]),this.tileAtlas=Loader.getImage("tiles"),this.anim=0,this.animBref=0,this.hero=new Hero(map,160,160,60,15,200,0,0,0,0,0,"pelle"),this.camera=new Camera(map,1024,768),this.camera.follow(this.hero),document.getElementById("map_canvas").addEventListener("click",function(){this.getBoundingClientRect();var e=this.getBoundingClientRect(),a=event.clientX-e.left+Game.camera.x,t=event.clientY-e.top+Game.camera.y,i=Game.hero.map.getRow(a),s=Game.hero.map.getCol(t),m=Game.hero.map.getRow(Game.hero.x),o=Game.hero.map.getCol(Game.hero.y),n=Game.hero.x,r=Game.hero.y,l=Game.hero.map.tsize/2;xHeroClick=n,yHeroClick=r,i>m&&i<m+3&&(clickCanvasX=1),i<m&&i>m-3&&(clickCanvasX=-1),0==clickCanvasX&&(s>o&&s<o+3&&(clickCanvasY=1),s<o&&s>o-3&&(clickCanvasY=-1)),Game._clickMenu(a,t,l,e)},!1),document.getElementById("creuse").addEventListener("click",function(){Game.hero.creuse(Game.hero.x,Game.hero.y,map)},!1),document.getElementById("speed0").addEventListener("click",function(){clearTimeout(e.timeOut)}),document.getElementById("speed1").addEventListener("click",function(){clearTimeout(e.timeOut),e.startTime(1e3)}),document.getElementById("speed2").addEventListener("click",function(){clearTimeout(e.timeOut),e.startTime(250)}),document.getElementById("speed3").addEventListener("click",function(){clearTimeout(e.timeOut),e.startTime(100)})},Game.update=function(e){var a=0,t=0;if(Keyboard.isDown(Keyboard.LEFT)?a=-1:Keyboard.isDown(Keyboard.RIGHT)?a=1:Keyboard.isDown(Keyboard.UP)?t=-1:Keyboard.isDown(Keyboard.DOWN)&&(t=1),this.hero.life<=0)return!1;0==clickCanvasX&&0==clickCanvasY||(a=clickCanvasX,t=clickCanvasY),this.hero.move(e,a,t),Object.keys(monsters).forEach(function(a){monsters[a].vitesse>0&&monsters[a].move(e,Game.hero.x,Game.hero.y)}),this.camera.update()},Game.getTool=function(){return document.querySelector('input[name="tools"]:checked').value},Game._drawLayer=function(e){var a=Math.floor(this.camera.x/map.tsize),t=a+this.camera.width/map.tsize,i=Math.floor(this.camera.y/map.tsize),s=i+this.camera.height/map.tsize,m=-this.camera.x+a*map.tsize,o=-this.camera.y+i*map.tsize;Game.anim++;for(var n=a;n<=t;n++)for(var r=i;r<=s;r++){var l=map.getTile(e,n,r);0==e&&(6==l?Game.anim>=DUREE_ANIMATION&&(abs2[r*map.rows+n]=7):7==l&&Game.anim>=DUREE_ANIMATION&&(abs2[r*map.rows+n]=6),8==l?Game.anim>=DUREE_ANIMATION&&(abs2[r*map.rows+n]=9):9==l&&Game.anim>=DUREE_ANIMATION&&(abs2[r*map.rows+n]=8));var c=(n-a)*map.tsize+m,h=(r-i)*map.tsize+o;0!==l&&this.ctx.drawImage(this.tileAtlas,(l-1)*map.tsize,0,map.tsize,map.tsize,Math.round(c),Math.round(h),map.tsize,map.tsize)}1==e&&(Object.keys(builds).forEach(function(e){1==builds[e].caracteristique.showLife&&Game._drawRectangle("#FFFFFF",builds[e].row*map.tsize-Math.round(Game.camera.x),builds[e].col*map.tsize-Math.round(Game.camera.y)+map.tsize+5,builds[e].life)}),Game.anim>=DUREE_ANIMATION/2?(Game.hero.image=Loader.getImage("hero2"),Object.keys(monsters).forEach(function(e){monsters[e].image=Loader.getImage(monsters[e].image1)})):(Game.hero.image=Loader.getImage("hero"),Object.keys(monsters).forEach(function(e){monsters[e].image=Loader.getImage(monsters[e].image2)})),"undefined"!=typeof anim&&null!==anim&&(Game.animBref<=DUREE_ANIMATION?(Game.ctx.drawImage(anim.image,0,0,map.tsize,map.tsize,anim.x-Game.camera.x,anim.y-Game.camera.y-Game.animBref,map.tsize,map.tsize),Game.animBref++,Game.animBref++):(anim=null,Game.animBref=0)),Object.keys(builds).forEach(function(e){6==builds[e].batiment&&0==builds[e].cible&&Object.keys(monsters).forEach(function(a){builds[e].calculPortee(builds[e].row,builds[e].col,builds[e].caracteristique.portee,monsters[a].row,monsters[a].col)&&(builds[e].cible=monsters[a])})}),Object.keys(builds).forEach(function(e){if(6==builds[e].batiment&&0!=builds[e].cible)if(yFinal=builds[e].cible.y,xFinal=builds[e].cible.x+20,builds[e].x>builds[e].cible.x?xDistance=builds[e].x-xFinal:xDistance=xFinal-builds[e].x,builds[e].y>yFinal?yDistance=builds[e].y-yFinal:yDistance=yFinal-builds[e].y,(builds[e].xDelta<=xDistance||builds[e].yDelta<=yDistance)&&builds[e].cible.life>0){if(builds[e].xDelta>=xDistance&&(builds[e].xDelta=xDistance),builds[e].yDelta>=yDistance&&(builds[e].yDelta=yDistance),builds[e].x>xFinal)a=builds[e].x-builds[e].xDelta-Game.camera.x;else var a=builds[e].x+builds[e].xDelta-Game.camera.x;if(builds[e].y>yFinal)t=builds[e].y-builds[e].yDelta-Game.camera.y;else var t=builds[e].y+builds[e].yDelta-Game.camera.y;Game.ctx.drawImage(Loader.getImage("ball"),0,0,map.tsize,map.tsize,a,t,map.tsize,map.tsize),builds[e].xDelta++,builds[e].yDelta++}else builds[e].xDelta=0,builds[e].yDelta=0,builds[e].cible.life=builds[e].cible.life-builds[e].caracteristique.attaque,builds[e].cible=0,builds[e].cibleMouvante=0})),Game.anim>=DUREE_ANIMATION&&(Game.anim=0)},Game._drawGridMenu=function(){for(var e,a,t=map.cols*map.tsize,i=map.rows*map.tsize,s=0;s<map.rows;s++)e=-this.camera.x,a=s*map.tsize-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(e,a),this.ctx.lineTo(t,a),this.ctx.stroke();for(var m=0;m<map.cols;m++)e=m*map.tsize-this.camera.x,a=-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(e,a),this.ctx.lineTo(e,i),this.ctx.stroke();this.ctx.drawImage(this.hero.image,this.hero.screenX-this.hero.width/2,this.hero.screenY-this.hero.height/2),this.hero.life<=0&&(this.ctx.font="50px Arial",this.ctx.fillText("VOUS AVEZ PERDU !",0,this.hero.screenY)),this._drawMenu()},Game._drawRectangle=function(e,a,t,i){this.ctx.fillStyle=e,this.ctx.fillRect(a,t,i,10)},Game.render=function(){this._drawLayer(0),this._drawLayer(1),Object.keys(monsters).forEach(function(e){monsters[e].life>0?(Game.ctx.drawImage(monsters[e].image,0,0,map.tsize,map.tsize,monsters[e].x-Game.camera.x,monsters[e].y-Game.camera.y,map.tsize,map.tsize),Game.ctx.fillStyle="#FF0000",Game.ctx.fillRect(2+monsters[e].x-Game.camera.x,monsters[e].y+70-Game.camera.y,monsters[e].life,10)):(Game.hero.xp=Game.hero.xp+5*monsters[e].level,document.getElementById("xp_value").innerHTML=Game.hero.xp,anim=new animation(map,monsters[e].x,monsters[e].y,"xp"),delete monsters[e])}),this.ctx.fillStyle="#FF0000",this.ctx.fillRect(this.hero.screenX-30,this.hero.screenY+40,this.hero.life,10),this._drawGridMenu()};