function Camera(e,a,i){this.x=0,this.y=0,this.width=a,this.height=i,this.maxX=e.cols*e.tsize-a,this.maxY=e.rows*e.tsize-i}function objet(e,a,i,t){this.name=e,this.life=i,this.attaque=t,this.image=Loader.getImage(a)}function animation(e,a,i,t){this.map=e,this.x=a,this.y=i,this.image=Loader.getImage(t)}DUREE_ANIMATION=50,builds=[],monsters=[],supply=[],objets=[],clickCanvasX=0,clickCanvasY=0,xHeroClick=0,yHeroClick=0,menuclick=0,menussclick=0,hour=0,day=1,Camera.prototype.follow=function(e){this.following=e,e.screenX=0,e.screenY=0},Camera.prototype.update=function(){0!=this.following.life&&(this.following.screenX=this.width/2,this.following.screenY=this.height/2,this.x=this.following.x-this.width/2,this.y=this.following.y-this.height/2,this.x=Math.max(0,Math.min(this.x,this.maxX)),this.y=Math.max(0,Math.min(this.y,this.maxY)),(this.following.x<this.width/2||this.following.x>this.maxX+this.width/2)&&(this.following.screenX=this.following.x-this.x),(this.following.y<this.height/2||this.following.y>this.maxY+this.height/2)&&(this.following.screenY=this.following.y-this.y))},Game.load=function(){return[Loader.loadImage("tiles","assets/tiles_new.png"),Loader.loadImage("hero","assets/character.png"),Loader.loadImage("hero2","assets/character2.png"),Loader.loadImage("troll2","assets/monstres/troll2.png"),Loader.loadImage("troll3","assets/monstres/troll3.png"),Loader.loadImage("scorpion1","assets/monstres/scorpion1.png"),Loader.loadImage("scorpion2","assets/monstres/scorpion2.png"),Loader.loadImage("coin","assets/coin.png"),Loader.loadImage("cloud","assets/cloud.png"),Loader.loadImage("xp","assets/xp.png"),Loader.loadImage("ball","assets/ball.png"),Loader.loadImage("pain","assets/menu/bread.png"),Loader.loadImage("fer","assets/menu/silver_ingot.png"),Loader.loadImage("bois","assets/menu/wood.png"),Loader.loadImage("ecu","assets/menu/bourse.png"),Loader.loadImage("farine","assets/menu/flour.png"),Loader.loadImage("cuivre","assets/menu/ironpowder.png"),Loader.loadImage("culture_ble","assets/menu/corn.png"),Loader.loadImage("ok","assets/menu/ok.png"),Loader.loadImage("ko","assets/menu/ko.png"),Loader.loadImage("action","assets/menu/action.png"),Loader.loadImage("pelle_bois","assets/objets/pelle.png"),Loader.loadImage("faux_bois","assets/objets/faux.png"),Loader.loadImage("epee_bois","assets/objets/epee.png"),Loader.loadImage("pelle_bois_use","assets/objets/pelle_use.png"),Loader.loadImage("faux_bois_use","assets/objets/faux_use.png"),Loader.loadImage("epee_bois_use","assets/objets/epee_use.png")]},Game.init=function(){var e=window,a=document,i=a.documentElement,t=a.getElementsByTagName("body")[0],s=e.innerWidth||i.clientWidth||t.clientWidth,o=e.innerHeight||i.clientHeight||t.clientHeight;canvas=document.getElementById("map_canvas"),canvas.width=s-50,canvas.height=o-100;canvas.getBoundingClientRect();var m=new Time;m.startTime(1e3),Keyboard.listenForEvents([Keyboard.LEFT,Keyboard.RIGHT,Keyboard.UP,Keyboard.DOWN]),this.tileAtlas=Loader.getImage("tiles"),this.anim=0,this.animBref=0,objets.pelle={img:"pelle_bois",name:"pelle"},objets.faux={img:"faux_bois",name:"faux"},objets.epee={img:"epee_bois",name:"epee"},this.hero=new Hero(map,160,160,60,15,200,0,objets.pelle),generateTroll(64,64,1,1),generateMonstre(map,384,128,6,2,10,10,.2,1,"scorpion1","scorpion2",2,-1,0),generateMonstre(map,384,192,6,3,10,10,.2,1,"scorpion1","scorpion2",1,-1,0),generateMonstre(map,576,192,9,3,3,10,.2,1,"scorpion1","scorpion2",1.2,0,1),this.camera=new Camera(map,s-50,o-100),this.camera.follow(this.hero),document.getElementById("map_canvas").addEventListener("click",function(){var e=this.getBoundingClientRect(),a=event.clientX-e.left+Game.camera.x,i=event.clientY-e.top+Game.camera.y,t=Game.hero.map.getRow(a),s=Game.hero.map.getCol(i),o=Game.hero.map.getRow(Game.hero.x),m=Game.hero.map.getCol(Game.hero.y),n=Game.hero.x,l=Game.hero.y,r=Game.hero.map.tsize/2;0==menussclick&&(xHeroClick=n,yHeroClick=l,t>o&&t<o+3&&s<m+3&&s>m-3&&t>0&&(clickCanvasX=1),t<o&&t>o-3&&s<m+3&&s>m-3&&t>0&&(clickCanvasX=-1),0==clickCanvasX&&(s>m&&s<m+3&&t>0&&(clickCanvasY=1),s<m&&s>m-3&&t>0&&(clickCanvasY=-1)));var a=event.clientX-e.left,i=event.clientY-e.top;a<60&&i>e.height/10&&i<e.height/10+64&&Game.hero.creuse(Game.hero.x,Game.hero.y,map),a<60&&i>e.height/4&&i<e.height/4+64&&(Game.hero.equipement=objets.pelle),a<60&&i>e.height/4+100&&i<e.height/4+64+100&&(Game.hero.equipement=objets.faux),a<60&&i>e.height/4+200&&i<e.height/4+64+200&&(Game.hero.equipement=objets.epee),0!=menussclick&&(a>249&&a<278&&i>e.height-5.5*r&&i<e.height-5.5*r+22&&Game.hero.addBuild(Game.hero.x,Game.hero.y,map,paramBuild.typeBatiment,caracteristique,Game.supplyBuild,paramBuild.typeTile,paramBuild.life,paramBuild.solid),a>289&&a<317&&i>e.height-5.5*r&&i<e.height-5.5*r+22&&(menussclick=0,menuclick=0)),Game._clickMenu(a,i,r,e,Game.hero.map.tsize)},!1),document.getElementById("speed0").addEventListener("click",function(){clearTimeout(m.timeOut)}),document.getElementById("speed1").addEventListener("click",function(){clearTimeout(m.timeOut),m.startTime(1e3)}),document.getElementById("speed2").addEventListener("click",function(){clearTimeout(m.timeOut),m.startTime(250)}),document.getElementById("speed3").addEventListener("click",function(){clearTimeout(m.timeOut),m.startTime(100)})},Game.update=function(e){var a=0,i=0;if(Keyboard.isDown(Keyboard.LEFT)?a=-1:Keyboard.isDown(Keyboard.RIGHT)?a=1:Keyboard.isDown(Keyboard.UP)?i=-1:Keyboard.isDown(Keyboard.DOWN)&&(i=1),this.hero.life<=0)return!1;0==clickCanvasX&&0==clickCanvasY||(a=clickCanvasX,i=clickCanvasY),this.hero.move(e,a,i),Object.keys(monsters).forEach(function(a){monsters[a].vitesse>0&&monsters[a].move(e,Game.hero.x,Game.hero.y)}),this.camera.update()},Game._drawLayer=function(e){var a=Math.floor(this.camera.x/map.tsize),i=a+this.camera.width/map.tsize,t=Math.floor(this.camera.y/map.tsize),s=t+this.camera.height/map.tsize,o=-this.camera.x+a*map.tsize,m=-this.camera.y+t*map.tsize;Game.anim++;for(var n=a;n<=i;n++)for(var l=t;l<=s;l++){var r=map.getTile(e,n,l);6==r?Game.anim>=DUREE_ANIMATION&&(abs2[l*map.rows+n]=7):7==r&&Game.anim>=DUREE_ANIMATION&&(abs2[l*map.rows+n]=6),8==r?Game.anim>=DUREE_ANIMATION&&(abs2[l*map.rows+n]=9):9==r&&Game.anim>=DUREE_ANIMATION&&(abs2[l*map.rows+n]=8);var c=(n-a)*map.tsize+o,d=(l-t)*map.tsize+m;0!==r&&this.ctx.drawImage(this.tileAtlas,(r-1)*map.tsize,0,map.tsize,map.tsize,Math.round(c),Math.round(d),map.tsize,map.tsize)}1==e&&(Object.keys(builds).forEach(function(e){1==builds[e].caracteristique.showLife&&Game._drawRectangle("#FFFFFF",builds[e].row*map.tsize-Math.round(Game.camera.x),builds[e].col*map.tsize-Math.round(Game.camera.y)+map.tsize+5,builds[e].life)}),Game.anim>=DUREE_ANIMATION/2?(Game.hero.image=Loader.getImage("hero2"),Object.keys(monsters).forEach(function(e){monsters[e].image=Loader.getImage(monsters[e].image1)})):(Game.hero.image=Loader.getImage("hero"),Object.keys(monsters).forEach(function(e){monsters[e].image=Loader.getImage(monsters[e].image2)})),"undefined"!=typeof anim&&null!==anim&&(Game.animBref<=DUREE_ANIMATION?(Game.ctx.drawImage(anim.image,0,0,map.tsize,map.tsize,anim.x-Game.camera.x,anim.y-Game.camera.y-Game.animBref,map.tsize,map.tsize),Game.animBref++,Game.animBref++):(anim=null,Game.animBref=0)),Object.keys(builds).forEach(function(e){6==builds[e].batiment&&0==builds[e].cible&&Object.keys(monsters).forEach(function(a){builds[e].calculPortee(builds[e].row,builds[e].col,builds[e].caracteristique.portee,monsters[a].row,monsters[a].col)&&(builds[e].cible=monsters[a])})}),Object.keys(builds).forEach(function(e){if(6==builds[e].batiment&&0!=builds[e].cible)if(yFinal=builds[e].cible.y,xFinal=builds[e].cible.x+20,builds[e].x>builds[e].cible.x?xDistance=builds[e].x-xFinal:xDistance=xFinal-builds[e].x,builds[e].y>yFinal?yDistance=builds[e].y-yFinal:yDistance=yFinal-builds[e].y,(builds[e].xDelta<=xDistance||builds[e].yDelta<=yDistance)&&builds[e].cible.life>0){if(builds[e].xDelta>=xDistance&&(builds[e].xDelta=xDistance),builds[e].yDelta>=yDistance&&(builds[e].yDelta=yDistance),builds[e].x>xFinal)a=builds[e].x-builds[e].xDelta-Game.camera.x;else var a=builds[e].x+builds[e].xDelta-Game.camera.x;if(builds[e].y>yFinal)i=builds[e].y-builds[e].yDelta-Game.camera.y;else var i=builds[e].y+builds[e].yDelta-Game.camera.y;Game.ctx.drawImage(Loader.getImage("ball"),0,0,map.tsize,map.tsize,a,i,map.tsize,map.tsize),builds[e].xDelta++,builds[e].yDelta++}else builds[e].xDelta=0,builds[e].yDelta=0,builds[e].cible.life=builds[e].cible.life-builds[e].caracteristique.attaque,builds[e].cible=0,builds[e].cibleMouvante=0})),Game.anim>=DUREE_ANIMATION&&(Game.anim=0)},Game._drawGridMenu=function(){map.cols,map.tsize,map.rows,map.tsize;this.ctx.drawImage(this.hero.image,this.hero.screenX-this.hero.width/2,this.hero.screenY-this.hero.height/2),this.hero.life<=0&&(this.ctx.font="50px Arial",this.ctx.fillText("VOUS AVEZ PERDU !",0,this.hero.screenY)),this._drawMenu()},Game._drawRectangle=function(e,a,i,t){this.ctx.fillStyle=e,this.ctx.fillRect(a,i,t,10)},Game.render=function(){this._drawLayer(0),this._drawLayer(1),Object.keys(monsters).forEach(function(e){monsters[e].life>0?(Game.ctx.drawImage(monsters[e].image,0,0,map.tsize,map.tsize,monsters[e].x-Game.camera.x,monsters[e].y-Game.camera.y,map.tsize,map.tsize),Game.ctx.fillStyle="#FF0000",Game.ctx.fillRect(2+monsters[e].x-Game.camera.x,monsters[e].y+70-Game.camera.y,monsters[e].life,10)):(Game.hero.xp=Game.hero.xp+5*monsters[e].level,anim=new animation(map,monsters[e].x,monsters[e].y,"xp"),delete monsters[e])}),this.ctx.fillStyle="#FF0000",this.ctx.fillRect(this.hero.screenX-30,this.hero.screenY+40,this.hero.life,10),this._drawGridMenu()};